# 数据导入脚本

本目录包含将清洗后的数据导入数据库的脚本。

## 导入流程

1. **连接数据库** - 建立 MySQL 数据库连接
2. **导入分类** - 先导入菜系、场景等分类数据
3. **导入食材** - 导入食材库（自动根据食材名称分类）
4. **导入菜谱** - 批量导入菜谱主表
5. **建立关联** - 建立菜谱-食材关联
6. **生成数据** - 生成点击量、收藏量等随机数据

## 脚本说明

### import_recipes.py
主要的导入脚本，功能包括：
- 批量插入数据（使用 Django bulk_create）
- 处理食材关联（先插入食材，再建立关联）
- 生成模拟统计数据
- 进度显示（使用 tqdm）
- 完整的错误处理和统计报告

**主要功能**：

| 功能 | 说明 |
|:-----|:-----|
| 数据加载 | 从 JSON 文件加载清洗后的菜谱数据 |
| 数据验证 | 检查必填字段（菜谱名称、食材信息） |
| 食材处理 | 自动根据食材名称猜测分类（蔬菜/肉类/海鲜/调料等） |
| 统计生成 | 生成点击量（100-50000）和收藏量（5%-20%） |
| 批量插入 | 使用 bulk_create 优化性能 |
| 外键处理 | 正确处理菜谱-食材的多对多关联 |

**食材自动分类**：

脚本内置了 100+ 种常见食材的分类规则：

| 分类 | 示例食材 |
|:-----|:--------|
| 蔬菜 (vegetable) | 白菜、菠菜、土豆、番茄、黄瓜、茄子、辣椒、豆腐 |
| 肉类 (meat) | 猪肉、牛肉、羊肉、鸡肉、鸭肉、火腿、鸡蛋 |
| 海鲜 (seafood) | 鱼、虾、蟹、海参、鱿鱼、海带 |
| 调料 (seasoning) | 盐、糖、酱油、醋、料酒、姜、蒜、葱 |
| 谷物 (grain) | 米、面、面条、粉丝 |
| 水果 (fruit) | 苹果、香蕉、梨、橙、葡萄 |
| 乳制品 (dairy) | 牛奶、酸奶、奶酪、黄油 |

### test_import.py
MySQL 版本的测试脚本，用于验证导入功能。

**注意**：需要 MySQL 连接，如果遇到 pymysql 版本兼容性问题，请使用 test_import_sqlite.py。

### test_import_sqlite.py
SQLite 版本的测试脚本，用于快速验证导入逻辑。

**优点**：
- 不需要 MySQL 连接
- 使用内存数据库，测试速度快
- 可以在本地快速验证导入逻辑

**缺点**：
- 仅用于测试，不能用于正式环境

## 使用方法

### 测试导入

```bash
cd data-scripts/importing

# 快速测试（推荐）
python test_import_sqlite.py

# MySQL 版本测试（需要 MySQL 连接）
python test_import.py
```

### 正式导入

```bash
cd data-scripts/importing

# 导入清洗后的数据
python import_recipes.py ../output/cleaned_recipes.json

# 导入测试数据
python import_recipes.py ../output/test_cleaned_output.json

# 指定批次大小（优化性能）
python import_recipes.py ../output/large_dataset.json --batch-size 500
```

## 数据生成规则

| 数据项 | 生成规则 | 备注 |
|:------|:--------|:-----|
| 点击量 | 100-50000 随机数 | 如果数据中已有，使用原值 |
| 收藏量 | 点击量的 5%-20% | 如果数据中已有，使用原值 |
| 难度 | 简单 40%、中等 40%、困难 20% | 如果数据中已有，使用原值 |
| 食材分类 | 根据名称自动分类 | 内置 100+ 种食材分类规则 |

## 性能优化

- 使用批量插入 (`bulk_create`)，默认批次大小 100
- 使用事务确保数据一致性
- 食材缓存避免重复查询
- 进度条显示实时进度

## 验证结果

**测试结果**（2026-01-30）：

```
✓ 使用 SQLite 版本测试通过
✓ 成功导入 4 条菜谱
✓ 创建 8 种食材
✓ 建立 8 条食材关联
✓ 统计数据生成正确
✓ 外键约束正确
```

**随机验证菜谱**：

```
名称:       宫保鸡丁
菜系:       川菜
难度:       中等
点击量:     1000
收藏量:     100
食材数量:   2
食材列表:
  - 鸡肉 (300g)
  - 花生 (50g)
```

## 输出格式

导入完成后，脚本会输出统计信息：

```
============================================================
导入完成！
============================================================
原始数据:     4 条
成功导入菜谱: 4 条
新增食材:     8 种
食材关联:     8 条
跳过记录:     0 条
============================================================
```

## 错误处理

脚本会记录所有错误信息，最多显示 10 条：

```
错误信息 (最多显示10条):
  - 跳过：菜谱缺少名称
  - 跳过：清蒸鱼 - 缺少食材信息
```

## 注意事项

1. **数据格式**：确保输入数据是清洗脚本输出的标准 JSON 格式
2. **外键约束**：食材表使用 CASCADE 删除，删除食材会自动删除关联
3. **事务处理**：导入过程使用事务，失败会自动回滚
4. **内存使用**：大批量数据导入时注意内存使用，可调整 `--batch-size`

## 下一步

导入完成后，可以：
1. 检查数据库中的数据
2. 运行 API 测试验证数据可用性
3. 开始开发阶段四：用户认证与权限系统
