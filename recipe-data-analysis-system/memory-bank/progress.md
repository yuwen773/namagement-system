# 菜谱数据分析系统 - 实施进度

> 更新日期: 2026-01-30

---

## 进度概览

| 阶段 | 名称 | 进度 |
|:----:|:------|:----:|
| 阶段一 | 项目初始化与基础架构 | 4/4 ✅ |
| 阶段二 | 数据库设计与模型创建 | 6/6 ✅ |
| 阶段三 | 数据准备与导入 | 1/6 ⏳ |

---

## 阶段一：项目初始化与基础架构 ✅

| 步骤 | 任务 | 日期 |
|:----:|:------|:----:|
| 1.1 | 创建前端项目结构 | 2026-01-29 |
| 1.2 | 创建后端项目结构 | 2026-01-29 |
| 1.3 | 创建数据脚本目录 | 2026-01-29 |
| 1.4 | 配置开发环境 | 2026-01-29 |

---

## 阶段二：数据库设计与模型创建 ✅

| 步骤 | 任务 | 状态 | 日期 |
|:----:|:------|:----:|:----:|
| 2.1 | 设计用户表结构 | ✅ | 2026-01-29 |
| 2.2 | 设计菜谱表结构 | ✅ | 2026-01-29 |
| 2.3 | 设计食材表与关联表 | ✅ | 2026-01-29 |
| 2.4 | 设计收藏表结构 | ✅ | 2026-01-29 |
| 2.5 | 设计用户行为表 | ✅ | 2026-01-29 |
| 2.6 | 创建分类/标签表 | ✅ | 2026-01-30 |

---

## 阶段三：数据准备与导入 ⏳

| 步骤 | 任务 | 状态 | 日期 |
|:----:|:------|:----:|:----:|
| 3.1 | 分析目标网站 | ✅ | 2026-01-30 |
| 3.2 | 编写菜谱爬取脚本 | ✅ 已验证 | 2026-01-30 |
| 3.3 | 编写数据清洗脚本 | ⏳ | - |
| 3.4 | 编写数据导入脚本 | ⏳ | - |
| 3.5 | 执行完整爬取并导入 | ⏳ | - |
| 3.6 | 模拟用户行为数据 | ⏳ | - |

### 阶段三步骤2完成总结

#### 创建的文件

| 文件 | 作用 |
|:-----|:-----|
| `data-scripts/spiders/request_utils.py` | HTTP请求工具（UA轮换、重试机制、Session管理）|
| `data-scripts/spiders/parser_utils.py` | HTML解析工具（菜谱名称、食材、步骤、难度分析）|
| `data-scripts/spiders/xiachufang_spider.py` | 下厨房爬虫主脚本 |
| `data-scripts/spiders/test_spider.py` | 简单测试脚本 |
| `data-scripts/simulation/recipe_data_simulator.py` | 数据模拟器（备选方案）|

#### 爬虫功能

**HTTP请求工具 (`request_utils.py`)**：
- 真实浏览器 User-Agent 轮换（10个UA）
- 自动重试机制（可配置重试次数和延迟）
- 请求间隔控制（5-10秒，避免触发反爬）
- Session 管理
- 图片下载功能
- Windows 控制台编码修复

**HTML解析工具 (`parser_utils.py`)**：
- 解析菜谱名称、图片URL、食材列表、制作步骤
- 智能分析难度等级（基于步骤和食材数量）
- 菜系识别（基于菜谱名称关键词）
- 口味标签提取
- 烹饪时间估算
- 多CSS选择器备选方案

**主爬虫脚本 (`xiachufang_spider.py`)**：
- 按ID范围批量爬取
- 进度显示和统计
- 定期保存数据
- 图片下载和本地存储
- 测试模式支持

#### 反爬策略

| 策略 | 状态 | 应对措施 |
|:-----|:----:|:---------|
| User-Agent 检测 | ✅ 需要 | UA 轮换（10个真实浏览器UA）|
| IP 限制 | ✅ 严格 | 5-10秒请求间隔，禁用429重试 |
| 登录要求 | ❌ 不需要 | 基础数据可公开访问 |
| 请求频率限制 | ✅ 严格 | 单线程，5-10秒间隔 |

#### 备选方案

由于下厨房网站有严格的反爬限制（429错误），创建了**数据模拟器**作为备选方案：

| 功能 | 说明 |
|:-----|:-----|
| 随机菜谱生成 | 支持自定义菜系、难度、场景、口味 |
| 食材生成 | 3-6种主料 + 2-4种调料 |
| 步骤生成 | 基于难度生成3-8步制作步骤 |
| 统计数据 | 模拟点击量（100-50000）和收藏量 |

**使用模拟器**：
```bash
cd data-scripts
python simulation/recipe_data_simulator.py
```

**使用爬虫**（需要等待IP解封或使用代理）：
```bash
cd data-scripts/spiders
python xiachufang_spider.py
```

#### 测试结果

**模拟器测试**：✅ 成功生成100条测试数据
**爬虫测试**：⚠️ 受限（429错误），需要：
- 等待IP解封（建议等待30分钟以上）
- 或使用代理IP池
- 或直接使用模拟数据继续开发

#### 验证结果（2026-01-30）

**用户验证**：✅ **测试通过**

- 数据模拟器运行正常
- 生成的数据格式正确
- 可以继续进行下一步（数据清洗脚本）

#### 数据格式

生成的 JSON 数据包含以下字段：
```json
{
  "recipe_id": 1,
  "name": "菜谱名称",
  "cuisine_type": "菜系",
  "scene_type": "场景",
  "difficulty": "easy/medium/hard",
  "cooking_time": 30,
  "flavor_tags": ["辣", "甜"],
  "image_url": "图片URL",
  "ingredients": [{"name": "食材名", "amount": "用量"}],
  "steps": ["步骤1", "步骤2"],
  "tips": "小贴士",
  "view_count": 1000,
  "favorite_count": 100
}
```

### 阶段三步骤1完成总结

#### 目标网站选择

| 网站 | URL | 状态 | 结论 |
|:-----|:----|:----:|:-----|
| 下厨房 | https://www.xiachufang.com | ✅ 可访问 | 主要爬取目标 |
| 美食杰 | https://www.meishij.net | ❌ 404 | 不可用 |

#### 网站结构分析成果

**URL 格式**：
- 菜谱详情页：`https://www.xiachufang.com/recipe/{recipe_id}/`
- 分类页：`https://www.xiachufang.com/category/`

**关键数据字段与选择器映射**：

| 字段 | CSS选择器 | 数据库映射 |
|:-----|:----------|:-----------|
| 菜谱名称 | `h1.page-title` | `recipes.name` |
| 成品图片 | `.recipe-cover img` | `recipes.image_url` |
| 用料列表 | `.recipe-ingredients` | `recipe_ingredients` |
| 制作步骤 | `.recipe-steps` | `recipes.steps` |
| 小贴士 | `.recipe-tip` | 额外提示 |

#### 反爬策略分析

| 策略 | 状态 | 应对措施 |
|:-----|:----:|:---------|
| User-Agent 检测 | ✅ 需要 | UA 轮换 |
| IP 限制 | ⚠️ 可能存在 | 2-5秒请求间隔 |
| 登录要求 | ❌ 不需要 | 基础数据可公开访问 |

#### 环境准备

已安装依赖：
- `requests` - HTTP 请求
- `beautifulsoup4` - HTML 解析
- `lxml` - 高性能解析器
- `pandas` - 数据处理

#### 已创建文件

| 文件 | 作用 |
|:-----|:-----|
| `data-scripts/spiders/website_analysis.md` | 完整的网站分析报告（9章节） |

---

## 待完成任务

### 阶段三剩余步骤
- [ ] 编写菜谱爬取脚本
- [ ] 编写数据清洗脚本
- [ ] 编写数据导入脚本
- [ ] 执行完整爬取并导入
- [ ] 模拟用户行为数据

---

## 数据库表状态

| 表名 | 状态 |
|:-----|:----:|
| users | ✅ |
| user_profiles | ✅ |
| recipes | ✅ |
| ingredients | ✅ |
| recipe_ingredients | ✅ |
| user_favorites | ✅ |
| user_behavior_logs | ✅ |
| categories | ✅ |

---

## 阶段二完成总结

### 已创建的文件

| 文件 | 作用 |
|:-----|:-----|
| `backend/categories/models.py` | Category 模型定义 |
| `backend/categories/migrations/0001_initial.py` | 创建 categories 表的迁移 |
| `backend/categories/migrations/0002_seed_initial_categories.py` | 插入初始分类数据（27条） |
| `backend/verify_category_model_sqlite.py` | SQLite 验证脚本 |

### 初始分类数据

| 类型 | 数量 | 内容 |
|:-----|:----:|:-----|
| 菜系 | 8 | 川菜、粤菜、鲁菜、苏菜、浙菜、湘菜、徽菜、闽菜 |
| 场景 | 7 | 早餐、午餐、晚餐、下午茶、夜宵、快手菜、宴客菜 |
| 人群 | 5 | 儿童、老人、孕妇、健身人群、素食者 |
| 口味 | 7 | 辣、甜、酸、咸、鲜、清淡、麻 |

---

## 备注

- 详细工作记录请查看 `project-status.md`
- 实施计划请查看 `implementation-plan.md`
