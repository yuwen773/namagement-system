# 测试数据生成工具

> 食堂管理系统测试数据生成工具使用文档
> 版本：v1.0
> 更新日期：2026-01-29

---

## 概述

测试数据生成工具是一个 Django 管理命令，用于快速生成符合业务逻辑的测试数据，覆盖系统 9 个核心业务表，每个表默认生成 100 条测试记录。

---

## 功能特性

- ✅ 自动生成 9 个业务表的测试数据
- ✅ 数据符合业务规则和依赖关系
- ✅ 支持自定义生成记录数量
- ✅ 自动数据验证（外键关系、薪资计算、考勤状态等）
- ✅ 可选择是否清空现有数据

---

## 数据表覆盖

| 表名 | 记录数 | 说明 |
|------|--------|------|
| employee_profiles | 100 | 员工档案，6种岗位类型分布 |
| shifts | 100 | 班次定义，6种班次类型 |
| users | 100 | 用户账号，管理员/员工角色 |
| schedules | 100 | 排班计划，2026年Q1数据 |
| shift_swap_requests | 100 | 调班申请，含审批流程 |
| attendance_records | 100 | 考勤记录，多种考勤状态 |
| leave_requests | 100 | 请假申请，3种请假类型 |
| salary_records | 100 | 薪资记录，符合计算公式 |
| appeals | 100 | 申诉记录，考勤/薪资申诉 |

---

## 使用方法

### 基本用法

```bash
# 进入后端目录
cd backend

# 生成默认 100 条测试数据
python manage.py generate_test_data

# 生成指定数量的测试数据
python manage.py generate_test_data --count 50

# 保留现有数据，追加新数据
python manage.py generate_test_data --skip-clear
```

### 命令参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--count COUNT` | 每个表生成的记录数量 | 100 |
| `--skip-clear` | 跳过清空数据步骤 | False |

---

## 数据生成规则

### 1. 员工档案 (employee_profiles)

**岗位分布：**
- 厨师 (CHEF): 15人
- 面点 (PASTRY): 12人
- 切配 (PREP): 20人
- 保洁 (CLEANER): 25人
- 服务员 (SERVER): 20人
- 经理 (MANAGER): 8人

**数据特征：**
- 姓名：随机中文姓名
- 性别：随机 男/女
- 手机号：138xxxxxxxx 格式
- 入职日期：2022-2025年随机
- 状态：90%在职，5%离职，5%停薪留职
- 健康证：H+8位数字，有效期1-3年
- 厨师证：厨师/面点岗位随机生成

### 2. 班次定义 (shifts)

**班次类型：**
- 早餐班 (05:30-10:00): 20条
- 中餐班 (10:00-14:30): 20条
- 晚餐班 (16:00-20:30): 20条
- 早中连班 (05:30-14:30): 15条
- 中晚连班 (10:00-20:30): 15条
- 全天班 (08:00-20:00): 10条

### 3. 用户账号 (users)

**角色分布：**
- 管理员 (ADMIN): 10个
- 普通员工 (EMPLOYEE): 90个

**关联规则：**
- 80% 关联到员工档案
- 20% 独立账号（测试用）
- 密码统一为 "123456"（开发阶段明文）

### 4. 排班计划 (schedules)

**时间范围：** 2026-01-01 至 2026-03-31

**生成规则：**
- 优先选择在职员工
- 确保排班日期 ≥ 入职日期
- 同一员工同一天不重复排班
- 随机分配班次

### 5. 调班申请 (shift_swap_requests)

**状态分布：**
- 待审批 (PENDING): 40%
- 已批准 (APPROVED): 35%
- 已拒绝 (REJECTED): 25%

**生成规则：**
- 目标日期在原日期前后7天内
- 选择不同班次
- 已审批记录包含审批人和审批意见

### 6. 考勤记录 (attendance_records)

**状态分布：**
- 正常 (NORMAL): 60%
- 迟到 (LATE): 20%
- 早退 (EARLY_LEAVE): 10%
- 缺卡 (MISSING): 10%

**生成规则：**
- 正常：签到/签退在班次时间±5分钟内
- 迟到：签到时间 = 开始时间 + 6~30分钟
- 早退：签退时间 = 结束时间 - 6~30分钟
- 缺卡：仅签到或仅签退
- 加班时长：0-3小时随机

### 7. 请假申请 (leave_requests)

**类型分布：**
- 病假 (SICK): 40%
- 事假 (PERSONAL): 40%
- 调休 (COMPENSATORY): 20%

**状态分布：**
- 待审批 (PENDING): 30%
- 已通过 (APPROVED): 50%
- 已驳回 (REJECTED): 20%

**生成规则：**
- 请假时长：1-7天
- 时间范围：2026-01-01 至 2026-03-31
- 已审批记录包含审批人和审批意见

### 8. 薪资记录 (salary_records)

**月份范围：** 2025-10 至 2026-01

**岗位基本工资范围：**
- 经理：8,000 - 12,000元
- 厨师：6,000 - 9,000元
- 面点：5,000 - 7,000元
- 切配：4,000 - 5,500元
- 服务员：3,500 - 5,000元
- 保洁：3,000 - 4,500元

**计算公式（符合系统规则）：**
```
日工资 = 月工资 ÷ 21.75天
时薪 = 日工资 ÷ 8小时
加班费 = 时薪 × 1.5 × 加班小时
扣款 = 迟到次数 × 20 + 缺卡次数 × 50
实发工资 = 基本工资 + 岗位津贴 + 加班费 - 扣款
```

**统计数据：**
- 出勤天数：20-23天
- 迟到次数：0-5次
- 缺卡次数：0-3次
- 加班时长：0-40小时

### 9. 申诉 (appeals)

**类型分布：**
- 考勤申诉 (ATTENDANCE): 50%
- 薪资申诉 (SALARY): 50%

**状态分布：**
- 待审批 (PENDING): 40%
- 已通过 (APPROVED): 35%
- 已驳回 (REJECTED): 25%

**生成规则：**
- 考勤申诉：关联到考勤记录ID
- 薪资申诉：关联到薪资记录ID
- 从预设申诉原因列表随机选择

---

## 数据验证

工具执行完成后会自动进行数据验证：

### 验证项目

1. **记录数量验证**
   - 每个表是否达到指定记录数

2. **外键关系验证**
   - User.employee_id 是否引用有效员工

3. **薪资计算验证**
   - 实发工资是否符合计算公式

4. **考勤状态验证**
   - 考勤状态是否根据签到/签退时间正确判断

### 验证输出示例

```
==================================================
数据验证结果：
==================================================
  [OK] employee_profiles: 100/100
  [OK] shifts: 100/100
  [OK] users: 100/100
  [OK] schedules: 100/100
  [OK] shift_swap_requests: 100/100
  [OK] attendance_records: 100/100
  [OK] leave_requests: 100/100
  [OK] salary_records: 100/100
  [OK] appeals: 100/100

外键关系验证：
  [OK] User.employee_id 引用: 0 个无效引用

薪资计算验证：
  [OK] 薪资计算正确: 0 个错误

考勤状态验证：
  [OK] 考勤状态正确: 0 个错误
==================================================

[OK] 所有数据验证通过！
```

---

## 文件结构

```
backend/employees/management/
├── __init__.py
└── commands/
    ├── __init__.py
    └── generate_test_data.py    # 主命令文件（850+行）
```

---

## 技术实现

### 依赖顺序

数据生成遵循表间依赖关系：

```
1. employee_profiles (基础数据)
2. shifts (基础数据)
3. users (可选关联employee)
4. schedules (关联employee, shift)
5. shift_swap_requests (关联schedule)
6. attendance_records (关联schedule)
7. leave_requests (关联employee)
8. salary_records (关联employee)
9. appeals (关联employee)
```

### 性能优化

- 使用 `bulk_create()` 批量插入数据
- 使用集合记录已使用的组合，避免重复查询
- 限制最大尝试次数，防止无限循环

### 事务处理

整个生成过程使用 `@transaction.atomic` 装饰器，确保数据一致性。如果生成过程中出现错误，所有更改将回滚。

---

## 预设数据列表

### 请假原因（20条）
身体不适、家中有事、医院检查、陪伴家人就医、家庭聚会、个人私事、调休补休、加班调休、外出办事、照顾生病家人、孩子学校有事、参加婚礼、办理证件、房屋装修、搬家、探亲访友、参加培训、驾照考试、银行办事、参加社区活动

### 调班原因（15条）
个人临时有事、家庭安排调整、医生预约、接送孩子、照顾老人、参加重要聚会、办理证件、房屋维修、其他个人原因、与其他员工协商调班、临时加班安排、培训学习、体检预约、学校家长会、重要约会

### 考勤申诉原因（10条）
实际正常上班系统误判迟到、因公外出导致缺卡、系统故障导致打卡失败、网络问题打卡未成功、替同事打卡忘记签退、会议延迟导致迟到、接待客户导致迟到、加班后忘记签退、考勤机故障、指纹识别问题

### 薪资申诉原因（10条）
加班费计算有误、扣款金额不正确、出勤天数统计错误、基本工资与合同不符、岗位津贴未发放、绩效工资计算错误、加班时长统计不准、请假扣款计算错误、奖金未计入、其他薪资问题

### 打卡地点（10处）
食堂大厅、后厨操作间、一楼餐厅、二楼餐厅、员工入口、后厨入口、配菜间、面点间、洗碗间、仓库

---

## 注意事项

1. **密码安全**：生成的测试数据使用明文密码 "123456"，仅用于开发环境，生产环境必须使用加密密码。

2. **数据清空**：默认执行会清空所有业务表数据，请谨慎在生产环境使用。

3. **唯一性约束**：
   - 用户名自动确保唯一
   - 员工+日期排班组合自动去重
   - 员工+月份薪资记录自动去重

4. **字符编码**：Windows控制台可能存在中文显示问题，但数据存储正常。

---

## 相关迁移

### 修复数据库schema不一致

在首次运行时发现 `attendance_records` 表存在 `overtime_hours` 字段，但 Django 模型中该字段为计算属性（property）。创建了迁移文件修复此问题：

**文件：** `backend/attendance/migrations/0002_remove_overtime_hours_column.py`

```python
operations = [
    migrations.RunSQL(
        "ALTER TABLE attendance_records DROP COLUMN overtime_hours;",
        reverse_sql="ALTER TABLE attendance_records ADD COLUMN overtime_hours DECIMAL(5,2) NOT NULL DEFAULT 0.00;"
    ),
]
```

---

## 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2026-01-29 | 初始版本，支持9个业务表测试数据生成 |

---

## 常见问题

### Q1: 如何只生成特定表的数据？

A: 当前版本不支持单独生成特定表，如需此功能可修改命令文件，注释掉不需要的生成方法调用。

### Q2: 生成的数据会重复吗？

A: 不会。命令内置了去重逻辑，确保：
- 用户名唯一
- 员工+日期排班唯一
- 员工+月份薪资记录唯一

### Q3: 如何修改生成的数据范围？

A: 编辑 `generate_test_data.py` 文件，修改相应方法中的日期范围或数据分布配置。

### Q4: 可以在生产环境使用吗？

A: 不建议。此工具用于开发测试环境，生产环境使用可能导致数据丢失。
